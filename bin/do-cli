#!/usr/bin/env node
var _ = require('lodash');
var minimist = require('minimist');
var fs = require('fs');
var DigitalOceanAPI = require('digitalocean-api');

var config = require(process.cwd()+'/do-conf');


var api = new DigitalOceanAPI(config.clientId, config.apiKey);

var argv = minimist(process.argv.slice(2), {
  alias: {
    list: 'ls',
    listNames: 'names',
    reboot: 'reboot',
    help: 'help'
  }
});

if (argv.help || (Object.keys(argv).length === 1 && argv._.length === 0)) {
  fs.createReadStream(__dirname + '/../usage.txt').pipe(process.stdout);
  return;
}

var outputName = function(name){
  return console.log(name+':\n');
};

if (argv.list){
  outputName('Droplets');
  api.dropletGetAll(function(error, droplets){
    if (error){
      console.log(error, 'You might want to check your do-conf.js file.');
    }
    console.log(droplets);
  });
}

if (argv.listNames){
  outputName('Droplet Names');
  api.dropletGetAll(function(error, droplets){
    if (error){
      console.log(error, 'You might want to check your do-conf.js file.');
    }
    _.each(droplets, function(i){
      console.log(i.name, i.id);
    });
  });
}

if (argv.reboot){
  var id = argv.reboot[0];
  outputName('Reboting');
  api.dropletReboot(id, function(error){
    console.log('Error:', error);
  });
}

